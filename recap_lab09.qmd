---
title: "Recap of Lab 8"
author: "Søren Helweg Dam, Daniel Romero"
format:
  revealjs:
    embed-resources: true
    theme: moon
    slide-number: c/t
    width: 1600
    height: 900
    mainfont: avenir
    logo: images/r4bds_logo_small.png
    footer: "R for Bio Data Science"
---

```{r setup}
#| include: false
knitr::opts_chunk$set(echo = FALSE)
```

# Exercises recap

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Lab 8 Learning Objectives

- Prepare a simple R package for distributing documented functions

- Explain the terms `Repository`, `Dependency`, and `Namespace`

- Implement testing in an R package

- Collaboratively work on an R package on GitHub

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Core Concepts

**What is an R package?**
  
- A `shareable` collection of `documented` code and/or data

![](images/L08_pkgdir.png){fig-align="center" height=400}

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Core Concepts

**What is a repository?**

- Specialized storage systems designed to manage source code and other software development assets
- e.g. a centralized folder with `git` version control and stored in GitHub

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Core Concepts

**What is a dependency?**
  
Any external thing your package relies on to work (most commonly, another package).

<br>

With `usethis`, we add dependencies like this:

```{r}
#| echo: true
#| eval: false
usethis::use_package("package_name")
```

<br>

We should try to avoid dependencies as much as we can (within reason), because:

- They increase the size of our package
- They increase maintenance
- Can introduce compatibility issues
- They are rarely completely avoidable

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Core Concepts

**What is a namespace?**
  
- A collection of names used to identify specific objects or functions
- From the perspective of a package, it is the names of every function or data object that will become available when you do `library("your_package")`
- R packages export names through the `NAMESPACE` file:

```{r}
#| eval: false
#| echo: true
# Generated by roxygen2: do not edit by hand

export(DNA_to_RNA)
export(amino_acid_counts_plot)
export(random_DNA)
export(subdivide_codons)
export(translate)
```

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Core Concepts

**What is a namespace?**
  
- A collection of names used to identify specific objects or functions
- From the perspective of a package, it is the names of every function or data object that will become available when you do `library("your_package")`
- R packages export names through the `NAMESPACE` file:

```{r}
#| eval: false
#| echo: true
# Generated by roxygen2: do not edit by hand

export(DNA_to_RNA)
export(amino_acid_counts_plot)
export(random_DNA)
export(subdivide_codons)
export(translate)
```

- Note: **The local namespace of a function is a different thing!** You can import functions from other packages into the function's namespace with `@importFrom package function` and `@import package` (we did this in function 5).

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## The package you built

<iframe src="images/L08_example.pdf" width="100%" height="800"></iframe>


<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## DESCRIPTION

```{sh}
#| eval: false
#| echo: true
Package: centralDogma
Type: Package
Title: Central Dogma
Version: 0.1.0
Description: simple R package that replicates the central dogma of molecular biology.
License: MIT + file LICENSE
Encoding: UTF-8
LazyData: true
Imports: 
    ggplot2,
    stringr
Depends:
    R (>= 4.0)
```

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
# Exercises

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Initial setup

* We created the R package project (RStudio simply creates the minimal files required for an R package)
* Added basic information to the `DESCRIPTION` file
* Connected it to GitHub: 
```{r}
#| eval: false
#| echo: true
usethis::use_git_remote(name = "origin", "https://github.com/rforbiodatascienceYY/group_X_package.git", overwrite = TRUE)
```

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Registering data objects

Making custom data available to the user of the package

```{r}
#| eval: false
#| echo: true
codon_table = c("UUU" = "F", "UCU" = "S", "UAU" = "Y", "UGU" = "C", ...)

usethis::use_data(codon_table, overwrite = TRUE, internal = TRUE)
```

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Implementing functions and their documentation

```{r}
#| eval: false
#| echo: true

#' Create a string of random DNA
#'
#' @param DNA_length length of the randomly created DNA
#'
#' @returns a string of random DNA
#' @export
random_DNA <- function(DNA_length){
  DNA_vec <- sample(c("A", "T", "G", "C"), size = DNA_length, replace = TRUE)
  DNA_str <- paste0(DNA_vec, collapse = "")
  return(DNA_str)
}
```

Those comments on top of the function is how an R package makes its documentation show up when running `?function_name` in the Console.

`devtools::document()` converts those comments into `.Rd` files in the `man` folder of the package using `roxygen2`. Otherwise you would have to write them yourself...

![](images/roxygen2.png){fig-align="center" height=180}

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Testing

The purpose of testing:

- They serve as sanity checks
- Future proofing: ensure that the behavior doesn't change when you update your function in the future
- Ensuring that a bug you fixed doesn't get re-introduced in a future update
- Defining the behavior of your function before you even start coding it (_test-driven development_)

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Testing

With `testhat`, we have a collection of `expect_*` functions that check for specific conditions

:::: {.columns}

::: {.column width="70%"}

```{r}
#| eval: false
#| echo: true

test_that("rnadom DNA has the correct length", {
  DNA_length <- 100
  generated_DNA <- random_DNA(DNA_length)
  
  expect_equal(nchar(generated_DNA), DNA_length)
})

test_that("all letters are valid DNA", {
  DNA_letters <- c("A", "C", "T", "G")

  generated_DNA <- random_DNA(400)
  generated_DNA <- strsplit(generated_DNA, "")[[1]] # transform to vector form
  
  is_valid_letter <- generated_DNA %in% DNA_letters
  expect_true(all(is_valid_letter))
})
```

:::

::: {.column width="30%"}

![](images/testthat.png){fig-align="center" height=250}
:::

::::

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Vignettes (group assignment)

- A vignette is a little "tutorial" that explains the basic functionality of a package
- It is **not** a replacement for documentation, but rather a starting point for new users

<iframe src="https://cran.r-project.org/web/packages/ggplot2/vignettes/ggplot2.html" width="100%" height="650"></iframe>

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
# Errors and challenges

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## The NAMESPACE file

```{r}
#| echo: true
#| eval: false
> devtools::document()
ℹ Updating cdogma documentation
ℹ Loading cdogma
Warning message:
Skipping NAMESPACE
✖ It already exists and was not generated by roxygen2.
```

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## The NAMESPACE file

```{r}
#| echo: true
#| eval: false
> devtools::document()
ℹ Updating cdogma documentation
ℹ Loading cdogma
Warning message:
Skipping NAMESPACE
✖ It already exists and was not generated by roxygen2.
```

</br>

**Solution:** Delete `NAMESPACE` file and rerun `devtools::document()`

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## The NAMESPACE file

```{r}
#| echo: true
#| eval: false
# Generated by roxygen2: do not edit by hand

<<<<<<< HEAD
export(function_x)
=======
export(function_y)
>>>>>>> e34c9e2848142b2afa6394733438e78434483ebc
```


<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## The NAMESPACE file

```{r}
#| echo: true
#| eval: false
# Generated by roxygen2: do not edit by hand

<<<<<<< HEAD
export(function_x)
=======
export(function_y)
>>>>>>> e34c9e2848142b2afa6394733438e78434483ebc
```

</br>

**Solution:** Fix merge conflicts

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Failing `devtools::check()`

```{r}
#| echo: true
#| eval: false
❯ checking examples ... ERROR
  Running examples in ‘cdogma-Ex.R’ failed
  The error most likely occurred in:
  
  > base::assign(".ptime", proc.time(), pos = "CheckExEnv")
  > ### Name: hello
  > ### Title: Hello, World!
  > ### Aliases: hello
  > 
  > ### ** Examples
  > 
  > hello()
  Error in hello() : could not find function "hello"
  Execution halted
```

<!--# ---------------------------------------------------------------------- -->
<!--# SLIDE ---------------------------------------------------------------- -->
<!--# ---------------------------------------------------------------------- -->
## Failing `devtools::check()`

```{r}
#| echo: true
#| eval: false
❯ checking examples ... ERROR
  Running examples in ‘cdogma-Ex.R’ failed
  The error most likely occurred in:
  
  > base::assign(".ptime", proc.time(), pos = "CheckExEnv")
  > ### Name: hello
  > ### Title: Hello, World!
  > ### Aliases: hello
  > 
  > ### ** Examples
  > 
  > hello()
  Error in hello() : could not find function "hello"
  Execution halted
```

</br>

**Solution:** Delete `R/hello.R` and `man/hello.md`


